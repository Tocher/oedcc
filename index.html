<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ОЭДиСС Казаков</title>
</head>
<body>

<input type='file' accept='text/plain' onchange='openFile(event)'>

<div id='output'>
</div>

<div id="container" style="width:100%; height:400px;"></div>

<script src="jdataview.js"></script>
<script src="jparser.js"></script>
<script src="jquery.min.js"></script>
<script src="highstock.js"></script>
<script>
    var seriesOptions = [],
        seriesCounter = 0,
        names = [
            //'01_04_2009_12_07_01_ch1_datafile.bin',
            //'01_04_2009_12_23_30_ch1_datafile.bin',
            //'01_04_2009_12_32_03_ch1_datafile.bin',
            '01_04_2009_12_21_01_ch1_datafile.bin'
        ];

    var openFile = function(event) {
        var input = event.target;

        var reader = new FileReader();
        reader.onload = function(e){
            var text = reader.result;
            openBin(text);
        };
        reader.readAsText(input.files[0]);
    };

    //debug
    var globalStock = [];

    $.each(names, function(i, e) {
        openBin(i, e);
    });

    function openBin(i, name) {
        $.ajax('data/' + name).done(function(data) {
            var parser = new jParser(data, {
                header: {
                    sign: ['string', 4],
                    channels: 'int32',
                    channel_size: 'int32',
                    spectral_lines: 'int32',
                    cutoff_frequency: 'int32',
                    frequency_resolution: 'float32',
                    block_receipt_time: 'float32',
                    block_receipt_time_total: 'int32',
                    block_count: 'int32',
                    block_size: 'int32',
                    block_count_real: 'int32',
                    block_size_max: 'float32',
                    block_size_min: 'float32'
                },
                body: {
                    _data: ['array', 'float32', (data.length - 100*4)/4]
                }
            });

            var currentData = {
                head: parser.parse('header'),
                body: parser.parse('body')
            };

            seriesOptions[i] = {
                name: name,
                data: currentData.body._data.map(function(e, i) {
                    return [i, e];
                })
            };

            // As we're loading the data asynchronously, we don't know what order it will arrive. So
            // we keep a counter and create the chart when all the data is loaded.
            seriesCounter += 1;

            if (seriesCounter === names.length) {
                createChart();
            }

        }, 'dataview');
    }

    /* sadasd */
    function createChart() {

        Highcharts.stockChart('container', {

//            rangeSelector: {
//                selected: 4
//            },

//            yAxis: {
//                labels: {
//                    formatter: function () {
//                        return (this.value > 0 ? ' + ' : '') + this.value + '%';
//                    }
//                },
//                plotLines: [{
//                    value: 0,
//                    width: 2,
//                    color: 'silver'
//                }]
//            },

//            yAxis: {
//                title: {
//                    text: 'Temperature (°C)'
//                }
//            },

//            plotOptions: {
//                series: {
//                    compare: 'percent',
//                    showInNavigator: true
//                }
//            },

//            tooltip: {
//                pointFormat: '<span style="color:{series.color}">{series.name}</span>: <b>{point.y}</b> ({point.change}%)<br/>',
//                valueDecimals: 2,
//                split: true
//            },

            series: seriesOptions
        });
    }
</script>
</body>
</html>