<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ОЭДиСС Казаков</title>
</head>
<body>

<input type='file' accept='text/plain' onchange='openFile(event)'>

<div id='output'>
</div>

<div id="container" style="width:100%; height:400px;"></div>

<script src="jdataview.js"></script>
<script src="jparser.js"></script>
<script src="jquery.min.js"></script>
<script src="highstock.js"></script>
<script>
    Array.prototype.max = function() {
        return Math.max.apply(null, this);
    };

    Array.prototype.min = function() {
        return Math.min.apply(null, this);
    };

    var seriesOptions = [],
        seriesCounter = 0,
        names = [
            '01_04_2009_12_07_01_ch1_datafile.bin'
            //'01_04_2009_12_23_30_ch1_datafile.bin',
            //'01_04_2009_12_32_03_ch1_datafile.bin',
            // '01_04_2009_12_21_01_ch1_datafile.bin'
        ];

    var openFile = function(event) {
        var input = event.target;

        var reader = new FileReader();
        reader.onload = function(e){
            var text = reader.result;

            Highcharts.charts.every(function(e){
                e && e.destroy();
            });
            seriesOptions = [];
            seriesCounter = 0;

            openBin(0, text.trim());
        };
        reader.readAsText(input.files[0]);
    };

    //debug
    var globalStock = [];

    $.each(names, function(i, e) {
        openBin(i, e);
    });

    function openBin(i, name) {
        // todo file name
        $.post('http://localhost:3000/', {name: name}).done(function(data) {
            var points = data.data;

            var chartData = [];
            points.map(function(e, i) {
                chartData.push([i, e]);
            });

            console.log('max:', data.block_size_max);
            console.log('min:', data.block_size_min);
            console.log('кол-во дискретный точек N:', data.channel_size);

            seriesOptions[i] = {
                name: name,
                data: chartData
            };

            // As we're loading the data asynchronously, we don't know what order it will arrive. So
            // we keep a counter and create the chart when all the data is loaded.
            seriesCounter += 1;

            if (seriesCounter === names.length) {
                createChart();
            }

        }, 'dataview');
    }

    /* sadasd */
    function createChart() {

        Highcharts.stockChart('container', {

//            rangeSelector: {
//                selected: 4
//            },

//            yAxis: {
//                labels: {
//                    formatter: function () {
//                        return (this.value > 0 ? ' + ' : '') + this.value + '%';
//                    }
//                },
//                plotLines: [{
//                    value: 0,
//                    width: 2,
//                    color: 'silver'
//                }]
//            },

//            yAxis: {
//                title: {
//                    text: 'Temperature (°C)'
//                }
//            },

//            plotOptions: {
//                series: {
//                    compare: 'percent',
//                    showInNavigator: true
//                }
//            },

//            tooltip: {
//                pointFormat: '<span style="color:{series.color}">{series.name}</span>: <b>{point.y}</b> ({point.change}%)<br/>',
//                valueDecimals: 2,
//                split: true
//            },

            series: seriesOptions
        });
    }
</script>
</body>
</html>